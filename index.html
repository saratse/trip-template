<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>旅程規劃系統</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* Theme Variables - Suikoden Style */
            --bg-dark: #0f172a;
            --primary: #1e3a8a;
            --accent: #d4af37;
            --accent-light: #fcd34d;
            --paper: #f5f5dc;
            --text-main: #2c2c2c;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            font-family: 'Noto Serif TC', serif;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 50%, #1e293b 0%, #0f172a 100%);
            color: var(--text-main);
            min-height: 100vh;
            padding-bottom: 90px;
        }

        /* Utility */
        .hidden { display: none !important; }
        .cinzel { font-family: 'Cinzel', serif; }

        /* --- LOCK SCREEN --- */
        #lockScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--accent); padding: 20px; transition: opacity 0.5s ease;
        }
        .pass-input {
            width: 100%; max-width: 300px; padding: 15px; font-size: 1.2rem;
            text-align: center; border: 2px solid var(--accent); background: rgba(0,0,0,0.5);
            color: white; border-radius: 8px; margin-bottom: 20px; letter-spacing: 2px;
        }
        .btn-unlock {
            width: 100%; max-width: 300px; padding: 12px; font-size: 1rem;
            background: var(--accent); color: #000; border: none; border-radius: 8px;
            font-weight: bold; cursor: pointer; box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
        }

        /* --- APP UI --- */
        #appContainer { opacity: 0; transition: opacity 0.5s ease; }
        #appContainer.fade-in { opacity: 1; }

        header {
            background: linear-gradient(180deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 58, 138, 0.8) 100%);
            color: var(--accent); padding: 15px; text-align: center;
            border-bottom: 2px solid var(--accent); box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            position: sticky; top: 0; z-index: 100; backdrop-filter: blur(5px);
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-btn { background: none; border: none; color: var(--accent); font-size: 1.2rem; cursor: pointer; }

        .container { padding: 15px; max-width: 600px; margin: 0 auto; }

        /* Cards */
        .rpg-card {
            background: var(--paper); border: 2px solid #8b7355; border-radius: 8px;
            padding: 15px; margin-bottom: 20px; position: relative;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }
        .rpg-card::before, .rpg-card::after {
            content: ''; position: absolute; width: 10px; height: 10px;
            border: 2px solid var(--accent);
        }
        .rpg-card::before { top: 4px; left: 4px; border-right: none; border-bottom: none; }
        .rpg-card::after { bottom: 4px; right: 4px; border-left: none; border-top: none; }

        .card-title {
            font-family: 'Cinzel', serif; font-weight: 700; color: #4a3b2a;
            border-bottom: 1px solid #8b7355; padding-bottom: 5px; margin-bottom: 10px;
            display: flex; align-items: center; gap: 8px;
        }

        /* Smart Text Display (Preserve line breaks) */
        .smart-text {
            white-space: pre-wrap; /* Critical for preserving user layout */
            font-family: 'Noto Serif TC', serif;
            line-height: 1.6;
            color: #333;
            width: 100%; border: none; background: transparent; resize: none;
            display: block;
        }
        .smart-text:focus { outline: 2px solid var(--accent); background: #fff; border-radius: 4px; padding: 5px; }

        /* Buttons */
        .btn {
            background: linear-gradient(180deg, #3b82f6 0%, #1d4ed8 100%);
            border: 1px solid #93c5fd; color: white; padding: 8px 16px;
            border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.9rem;
            text-align: center; text-decoration: none; display: inline-block;
        }
        .btn-gold { background: linear-gradient(180deg, #fcd34d 0%, #d97706 100%); border: 1px solid #fde68a; color: #451a03; }
        .btn-danger { background: linear-gradient(180deg, #ef4444 0%, #b91c1c 100%); border-color: #fca5a5; }
        
        /* Navigation */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(0deg, #0f172a 0%, #1e293b 100%);
            display: flex; justify-content: space-around; padding: 10px 0;
            border-top: 2px solid var(--accent); z-index: 1000;
        }
        .nav-item { color: #64748b; background: none; border: none; flex: 1; text-align: center; font-size: 0.75rem; cursor: pointer; }
        .nav-item.active { color: var(--accent); text-shadow: 0 0 5px rgba(212, 175, 55, 0.5); }
        .nav-item i { display: block; font-size: 1.2rem; margin-bottom: 4px; }

        /* Timeline */
        .timeline { position: relative; padding-left: 20px; border-left: 3px solid var(--accent); margin-left: 10px; }
        .timeline-item { margin-bottom: 25px; position: relative; }
        .timeline-dot {
            position: absolute; left: -33px; top: 0; width: 26px; height: 26px;
            background: var(--accent); border-radius: 50%; border: 2px solid #fff;
            display: flex; justify-content: center; align-items: center; font-size: 14px; color: #451a03;
        }
        .timeline-time { font-family: 'Cinzel', serif; font-weight: bold; color: var(--accent-light); font-size: 1.1rem; margin-bottom: 4px; }
        .timeline-content { background: rgba(255, 255, 255, 0.85); border-radius: 6px; padding: 10px; border: 1px solid #d1d5db; }
        .timeline-img-preview { margin-top: 10px; width: 100%; height: 120px; object-fit: cover; border-radius: 4px; cursor: pointer; }

        /* Date Tabs */
        .date-tabs { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; margin-bottom: 15px; }
        .date-tab {
            background: rgba(255,255,255,0.2); color: #ddd; padding: 6px 12px;
            border-radius: 15px; white-space: nowrap; border: 1px solid transparent; flex-shrink: 0;
        }
        .date-tab.active { background: var(--accent); color: #2c2c2c; border-color: #fff; font-weight: bold; }

        /* Modals */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: flex; justify-content: center;
            align-items: center; z-index: 2000;
        }
        .modal-content {
            background: var(--paper); padding: 20px; border-radius: 8px; width: 90%; max-width: 500px;
            border: 2px solid var(--accent); max-height: 95vh; overflow-y: auto; display: flex; flex-direction: column;
        }
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #8b7355; background: #fffef0; border-radius: 4px; }
        
        /* Personal Info */
        .input-group { display: flex; gap: 5px; margin-bottom: 10px; }
        .btn-copy { width: 44px; background: #475569; color: #fff; border: 1px solid #64748b; border-radius: 4px; cursor: pointer; }

        /* Memos */
        .memo-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .memo-card { background: #fffef0; border: 1px solid #d4af37; padding: 15px; border-radius: 2px; position: relative; }
        .memo-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 20px; background: rgba(212, 175, 55, 0.2); }
        .memo-img { width: 100%; margin-top: 10px; border-radius: 4px; cursor: pointer; }

        /* Lightbox & Spotlight */
        .lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; display: flex; justify-content: center; align-items: center; }
        .lightbox img { max-width: 95%; max-height: 95%; object-fit: contain; }
        .spotlight-card { background: var(--paper); padding: 30px; width: 100%; max-height: 90vh; overflow-y: auto; text-align: center; border: 4px solid var(--accent); }
        .spotlight-text { font-size: 1.8rem; font-weight: bold; margin-bottom: 20px; white-space: pre-wrap; }

        .upload-area { border: 2px dashed #8b7355; padding: 15px; text-align: center; cursor: pointer; background: rgba(255,255,255,0.5); margin-bottom: 10px; }
    </style>
</head>
<body>

    <!-- LOCK SCREEN -->
    <div id="lockScreen">
        <h1 class="cinzel" style="font-size:2rem; margin-bottom:30px; text-shadow:0 0 10px var(--accent);">Destiny Trip</h1>
        <input type="password" id="passwordInput" class="pass-input" placeholder="輸入旅程代碼" onkeypress="handleEnter(event)">
        <button class="btn-unlock" onclick="attemptLogin()">開啟卷軸</button>
        <div id="loginError" style="color:#ef4444; margin-top:15px; min-height:20px;"></div>
        <div style="margin-top:20px; font-size:0.8rem; color:#888; text-align:center;">
            Demo: demo (範本) / New: new (空白)<br>
            東京: 20251210
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="appContainer" class="hidden">
        <header>
            <div style="width:30px;"></div> <!-- Spacer -->
            <div style="text-align:center;">
                <h1 class="cinzel" style="margin:0; font-size:1.3rem;"><i class="fa-solid fa-dragon"></i> <span id="headerTitle">旅程</span></h1>
                <div id="headerDate" style="font-size:0.75rem; color:#aaa;"></div>
            </div>
            <button class="header-btn" onclick="openSettingsModal()"><i class="fa-solid fa-gear"></i></button>
        </header>

        <div class="container">
            <!-- SECTION: BOOKING -->
            <section id="sec-booking">
                <div class="rpg-card">
                    <div class="card-title"><i class="fa-solid fa-plane-departure"></i> 航班資訊</div>
                    <!-- Smart Textarea for User Input -->
                    <textarea id="flightInfo" class="smart-text" rows="5" placeholder="請在此貼上航班資訊...
例：
去程 UO624 12/10 23:55
回程 UO629 12/14 01:55" readonly onclick="enableEdit(this)" onblur="saveSectionText('flightInfo', this.value)"></textarea>
                </div>

                <div class="rpg-card">
                    <div class="card-title"><i class="fa-solid fa-bed"></i> 住宿據點</div>
                    <textarea id="hotelInfo" class="smart-text" rows="5" placeholder="請在此輸入飯店資訊...
例：
Dormy Inn Ikebukuro
地址：東京都豊島區..." readonly onclick="enableEdit(this)" onblur="saveSectionText('hotelInfo', this.value)"></textarea>
                    <div style="margin-top:10px; text-align:right;">
                        <a id="hotelMapLink" href="https://www.google.com/maps" target="_blank" class="btn btn-gold btn-sm"><i class="fa-solid fa-map-location-dot"></i> 導航</a>
                    </div>
                </div>

                <div class="rpg-card">
                    <div class="card-title"><i class="fa-solid fa-address-card"></i> 個人資訊 (僅存本機)</div>
                    <div id="personalInfoContainer"></div>
                </div>
            </section>

            <!-- SECTION: ITINERARY -->
            <section id="sec-itinerary" class="hidden">
                <div class="date-tabs" id="dayTabs"></div>
                <div id="itineraryContent"></div>
                <div style="height:60px;"></div>
            </section>

            <!-- SECTION: MEMO -->
            <section id="sec-memo" class="hidden">
                <div class="rpg-card">
                    <div class="card-title"><i class="fa-solid fa-clipboard-check"></i> 行前清單</div>
                    <div id="checklistContainer"></div>
                    <div style="margin-top:10px; display:flex; gap:5px;">
                        <input type="text" id="newCheckItem" placeholder="新增項目..." style="margin-bottom:0;">
                        <button class="btn btn-gold" onclick="addCheckItem()">+</button>
                    </div>
                </div>
                <div style="margin-top:20px;">
                    <div class="card-title" style="color:white; border-bottom-color:var(--accent);"><i class="fa-solid fa-note-sticky"></i> 旅人筆記 (Spotlight)</div>
                    <div id="memoContainer" class="memo-grid"></div>
                </div>
            </section>

            <!-- SECTION: INFO -->
            <section id="sec-info" class="hidden">
                <div class="rpg-card">
                    <div class="card-title"><i class="fa-solid fa-cloud-sun-rain"></i> 天氣預報</div>
                    <div id="weatherDisplay" class="weather-widget"><i class="fa-solid fa-spinner fa-spin"></i> 讀取中...</div>
                </div>
                <div class="rpg-card">
                    <div class="card-title"><i class="fa-solid fa-kit-medical"></i> 緊急聯絡</div>
                    <div class="info-row"><span class="label">警察 (110)</span><a href="tel:110" class="btn btn-danger btn-sm">撥打</a></div>
                    <div class="info-row"><span class="label">救護 (119)</span><a href="tel:119" class="btn btn-danger btn-sm">撥打</a></div>
                </div>
            </section>
        </div>

        <!-- FAB -->
        <div id="fabAdd" class="fab hidden" onclick="handleFabClick()"><i class="fa-solid fa-plus"></i></div>

        <!-- NAV -->
        <nav class="nav-bar">
            <button class="nav-item active" onclick="switchTab('sec-booking', this)"><i class="fa-solid fa-ticket"></i> 預訂</button>
            <button class="nav-item" onclick="switchTab('sec-itinerary', this)"><i class="fa-solid fa-scroll"></i> 行程</button>
            <button class="nav-item" onclick="switchTab('sec-memo', this)"><i class="fa-solid fa-list-check"></i> 清單</button>
            <button class="nav-item" onclick="switchTab('sec-info', this)"><i class="fa-solid fa-circle-info"></i> 資訊</button>
        </nav>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="modal hidden">
        <div class="modal-content">
            <h3 class="cinzel" style="margin-top:0;"><i class="fa-solid fa-gear"></i> 旅程設定</h3>
            <label style="font-weight:bold; color:#666;">旅程標題</label>
            <input type="text" id="settingTitle">
            <label style="font-weight:bold; color:#666;">開始日期 (計算 Day1 用)</label>
            <input type="date" id="settingStartDate">
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn btn-danger" style="flex:1;" onclick="closeModal('settingsModal')">取消</button>
                <button class="btn btn-gold" style="flex:1;" onclick="saveSettings()">儲存設定</button>
            </div>
        </div>
    </div>

    <!-- EDIT ITINERARY MODAL -->
    <div id="editModal" class="modal hidden">
        <div class="modal-content">
            <h3 class="cinzel" style="margin-top:0;"><i class="fa-solid fa-pen-nib"></i> 編輯行程</h3>
            <input type="hidden" id="editId">
            
            <label style="font-weight:bold; color:#666;">日期 & 時間</label>
            <div style="display:flex; gap:5px;">
                <input type="date" id="editDate" style="flex:1;">
                <input type="time" id="editTime" style="flex:1;">
            </div>

            <label style="font-weight:bold; color:#666;">標題</label>
            <input type="text" id="editTitle">
            
            <label style="font-weight:bold; color:#666;">備註 (自動換行)</label>
            <textarea id="editDesc" rows="5"></textarea>
            
            <label style="font-weight:bold; color:#666;">圖片</label>
            <div class="upload-area" onclick="document.getElementById('editImageInput').click()" id="uploadDropZone">
                <i class="fa-solid fa-image"></i><p>上傳或貼上圖片</p>
                <input type="file" id="editImageInput" accept="image/*" onchange="handleImageUpload(this, 'itinerary')" style="display:none;">
            </div>
            <div id="editImagePreviewContainer" style="display:none; text-align:center; margin-bottom:10px;">
                <img id="editImagePreview" src="" style="max-height:100px;">
                <button class="btn btn-danger btn-sm" onclick="clearEditImage('itinerary')">刪除</button>
            </div>

            <label style="font-weight:bold; color:#666;">類型 & 連結</label>
            <div style="display:flex; gap:5px;">
                <select id="editType" style="flex:1;">
                    <option value="activity">活動</option><option value="food">用餐</option>
                    <option value="shopping">購物</option><option value="transport">交通</option>
                </select>
                <input type="text" id="editLink" placeholder="URL" style="flex:2;">
            </div>

            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn btn-danger" style="flex:1;" onclick="closeModal('editModal')">取消</button>
                <button class="btn btn-gold" style="flex:1;" onclick="saveItineraryItem()">儲存</button>
            </div>
            <button id="btnDeleteItinerary" class="btn btn-danger" style="width:100%; margin-top:10px;" onclick="deleteItem()">刪除</button>
        </div>
    </div>

    <!-- MEMO MODAL (Same as V7) -->
    <div id="memoModal" class="modal hidden">
        <div class="modal-content">
            <h3 class="cinzel" style="margin-top:0;"><i class="fa-solid fa-note-sticky"></i> 編輯便條</h3>
            <input type="hidden" id="memoId">
            <textarea id="memoText" rows="5" placeholder="內容..."></textarea>
            <div class="upload-area" onclick="document.getElementById('memoImageInput').click()" id="memoDropZone"><i class="fa-solid fa-camera"></i><p>上傳或貼上</p><input type="file" id="memoImageInput" accept="image/*" onchange="handleImageUpload(this, 'memo')" style="display:none;"></div>
            <div id="memoImagePreviewContainer" style="display:none; text-align:center; margin-bottom:10px;"><img id="memoImagePreview" src="" style="max-height:100px;"><br><button class="btn btn-danger btn-sm" onclick="clearEditImage('memo')">刪除</button></div>
            <div style="display:flex; gap:10px; margin-top:15px;"><button class="btn btn-danger" style="flex:1;" onclick="closeModal('memoModal')">取消</button><button class="btn btn-gold" style="flex:1;" onclick="saveMemo()">儲存</button></div>
        </div>
    </div>

    <!-- LIGHTBOX & SPOTLIGHT -->
    <div id="lightbox" class="lightbox hidden" onclick="closeLightbox()"><img id="lightboxImg" src=""></div>
    <div id="memoSpotlight" class="lightbox hidden" onclick="closeMemoSpotlight()">
        <div class="spotlight-card" onclick="event.stopPropagation()">
            <div id="memoSpotlightText" class="spotlight-text"></div>
            <img id="memoSpotlightImg" class="spotlight-img hidden">
            <div style="margin-top:30px;"><button class="btn btn-danger" onclick="closeMemoSpotlight()">關閉</button></div>
        </div>
    </div>

    <script>
        // --- DATA DEFAULTS ---
        const DATA_VERSION = 8.0; 
        
        // 範本：東京
        const PRESET_TOKYO = {
            title: '東京快閃 2025', startDate: '2025-12-11',
            flightInfo: "去程 UO624 12/10 23:55\n回程 UO629 12/14 01:55",
            hotelInfo: "Dormy Inn Ikebukuro\n東京都豊島區東池袋3-11-11",
            itinerary: [
                { id: 1, date: '2025-12-11', time: '04:45', title: '抵達羽田 T3', desc: '入境 / SIM卡 / 寄行李', type: 'transport', link: '' },
                { id: 2, date: '2025-12-12', time: '10:00', title: 'Gallery AaMo', desc: '展覽二刷', type: 'activity', link: '' }
            ],
            checklist: [{text:'護照',checked:false}], memos: [], personalInfo: {}
        };

        const BLANK_TEMPLATE = {
            title: '新旅程', startDate: new Date().toISOString().split('T')[0],
            flightInfo: '', hotelInfo: '', itinerary: [], checklist: [], memos: [], personalInfo: {}
        };

        // --- STATE ---
        let appData = null;
        let currentSessionKey = '';
        let currentEditingImage = null;
        let activeTabId = 'sec-booking';
        let currentRenderDate = ''; // For Itinerary tabs

        // --- LOGIN ---
        function handleEnter(e) { if(e.key==='Enter') attemptLogin(); }
        function attemptLogin() {
            const key = document.getElementById('passwordInput').value.trim();
            if (!key) return document.getElementById('loginError').innerText = "請輸入代碼";

            const storageKey = 'trip_v8_' + key;
            const saved = localStorage.getItem(storageKey);

            if (saved) {
                appData = JSON.parse(saved);
            } else {
                if (key === '20251210') appData = JSON.parse(JSON.stringify(PRESET_TOKYO));
                else if (key === 'demo') appData = JSON.parse(JSON.stringify(PRESET_TOKYO)); // Reuse for demo
                else if (key === 'new') appData = JSON.parse(JSON.stringify(BLANK_TEMPLATE));
                else return document.getElementById('loginError').innerText = "無效代碼";
            }
            
            // Migration for older keys if logic changed (omitted for clean V8)
            currentSessionKey = key;
            initUI();
        }

        function initUI() {
            // Update Header
            updateHeaderUI();
            
            // Fill Fields
            document.getElementById('flightInfo').value = appData.flightInfo || '';
            document.getElementById('hotelInfo').value = appData.hotelInfo || '';
            
            // Set first day
            if(appData.itinerary.length > 0) {
                // Sort itinerary by date first
                appData.itinerary.sort((a,b) => (a.date + a.time).localeCompare(b.date + b.time));
                currentRenderDate = appData.itinerary[0].date;
            } else {
                currentRenderDate = appData.startDate;
            }

            renderPersonalInfo();
            renderChecklist();
            renderMemos();
            fetchWeather();
            renderItinerary();

            // Transition
            document.getElementById('lockScreen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('lockScreen').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                setTimeout(() => document.getElementById('appContainer').classList.add('fade-in'), 50);
            }, 500);
        }

        function updateHeaderUI() {
            document.getElementById('headerTitle').innerText = appData.title;
            document.getElementById('headerDate').innerText = `Start: ${appData.startDate}`;
        }

        function saveData() {
            if(!currentSessionKey) return;
            localStorage.setItem('trip_v8_' + currentSessionKey, JSON.stringify(appData));
        }

        // --- SETTINGS ---
        function openSettingsModal() {
            document.getElementById('settingTitle').value = appData.title;
            document.getElementById('settingStartDate').value = appData.startDate;
            document.getElementById('settingsModal').classList.remove('hidden');
        }
        function saveSettings() {
            appData.title = document.getElementById('settingTitle').value;
            appData.startDate = document.getElementById('settingStartDate').value;
            saveData();
            updateHeaderUI();
            renderItinerary(); // Re-render to update Day numbers
            closeModal('settingsModal');
        }

        // --- SMART TEXTAREA ---
        function enableEdit(el) {
            el.removeAttribute('readonly');
            el.style.background = '#fff';
            el.style.border = '1px solid #d4af37';
        }
        function saveSectionText(field, val) {
            appData[field] = val;
            saveData();
            const el = document.getElementById(field);
            el.setAttribute('readonly', true);
            el.style.background = 'transparent';
            el.style.border = 'none';
        }

        // --- ITINERARY LOGIC (Dynamic Dates) ---
        function getDayLabel(dateStr) {
            const start = new Date(appData.startDate);
            const current = new Date(dateStr);
            const diffTime = current - start;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // Day 1 based
            // Format MD
            const md = `${current.getMonth()+1}/${current.getDate()}`;
            return `${md} (Day ${diffDays})`;
        }

        function getUniqueDates() {
            // Get all dates from itinerary
            const dates = new Set(appData.itinerary.map(i => i.date));
            // Always ensure start date is included if empty
            if (dates.size === 0) dates.add(appData.startDate);
            return Array.from(dates).sort();
        }

        function renderDayTabs() {
            const c = document.getElementById('dayTabs'); c.innerHTML = '';
            const dates = getUniqueDates();
            
            // Safety check
            if(!dates.includes(currentRenderDate)) currentRenderDate = dates[0];

            dates.forEach(d => {
                const btn = document.createElement('button');
                btn.className = `date-tab ${d===currentRenderDate?'active':''}`;
                btn.innerHTML = getDayLabel(d);
                btn.onclick = () => { currentRenderDate = d; renderDayTabs(); renderItinerary(); };
                c.appendChild(btn);
            });
        }

        function renderItinerary() {
            renderDayTabs();
            const c = document.getElementById('itineraryContent'); c.innerHTML = '';
            
            const items = appData.itinerary.filter(i => i.date === currentRenderDate).sort((a,b) => a.time.localeCompare(b.time));
            
            if(items.length === 0) { c.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">本日無行程，請點擊 + 新增</div>'; return; }
            
            const list = document.createElement('div'); list.className = 'timeline';
            items.forEach(item => {
                let icon='fa-circle';
                if(item.type==='food') icon='fa-utensils';
                if(item.type==='transport') icon='fa-train-subway';
                if(item.type==='shopping') icon='fa-bag-shopping';
                
                let linkHtml = item.link ? `<a href="${item.link}" target="_blank" class="btn btn-gold btn-sm"><i class="fa-solid fa-link"></i></a>` : '';
                let imgHtml = item.image ? `<img src="${item.image}" class="timeline-img-preview" onclick="openLightbox('${item.image}')">` : '';
                
                // Smart link detection in description
                let descHtml = linkify(item.desc).replace(/\n/g,'<br>');

                list.innerHTML += `
                <div class="timeline-item">
                    <div class="timeline-dot"><i class="fa-solid ${icon}"></i></div>
                    <div class="timeline-time">${item.time}</div>
                    <div class="timeline-content">
                        <div style="font-weight:bold; font-size:1.1rem;">${item.title}</div>
                        <div style="font-size:0.9rem; color:#555; margin-top:4px; line-height:1.4;">${descHtml}</div>
                        ${imgHtml}
                        <div class="timeline-actions">
                            ${linkHtml}
                            <button class="btn btn-sm" style="background:#555;" onclick="openEditModal(${item.id})"><i class="fa-solid fa-pen"></i></button>
                        </div>
                    </div>
                </div>`;
            });
            c.appendChild(list);
        }

        // --- EDIT ITINERARY (With Date Picker) ---
        let editItineraryId = null;
        function openEditModal(id=null) {
            editItineraryId = id;
            clearEditImage('itinerary');
            const delBtn = document.getElementById('btnDeleteItinerary');
            
            if(id) {
                delBtn.classList.remove('hidden');
                const item = appData.itinerary.find(i=>i.id===id);
                document.getElementById('editDate').value = item.date;
                document.getElementById('editTime').value = item.time;
                document.getElementById('editTitle').value = item.title;
                document.getElementById('editDesc').value = item.desc;
                document.getElementById('editType').value = item.type;
                document.getElementById('editLink').value = item.link || '';
                if(item.image) {
                    currentEditingImage = item.image;
                    document.getElementById('editImagePreview').src = item.image;
                    document.getElementById('editImagePreviewContainer').style.display = 'block';
                }
            } else {
                delBtn.classList.add('hidden');
                document.getElementById('editDate').value = currentRenderDate; // Default to current tab
                document.getElementById('editTime').value = '10:00';
                document.getElementById('editTitle').value = '';
                document.getElementById('editDesc').value = '';
                document.getElementById('editType').value = 'activity';
                document.getElementById('editLink').value = '';
            }
            document.getElementById('editModal').classList.remove('hidden');
        }

        function saveItineraryItem() {
            const date = document.getElementById('editDate').value;
            const time = document.getElementById('editTime').value;
            const title = document.getElementById('editTitle').value;
            if(!date || !title) return alert('請填寫日期與標題');

            const newItem = {
                id: editItineraryId || Date.now(),
                date: date,
                time: time,
                title: title,
                desc: document.getElementById('editDesc').value,
                type: document.getElementById('editType').value,
                link: document.getElementById('editLink').value,
                image: currentEditingImage
            };

            if(editItineraryId) {
                const idx = appData.itinerary.findIndex(i=>i.id===editItineraryId);
                if(idx!==-1) appData.itinerary[idx] = newItem;
            } else {
                appData.itinerary.push(newItem);
            }

            // Switch view to the date we just edited/added
            currentRenderDate = date;
            
            closeModal('editModal'); renderItinerary(); setTimeout(saveData, 50);
        }

        function deleteItem() {
            if(confirm('刪除?')) {
                appData.itinerary = appData.itinerary.filter(i=>i.id!==editItineraryId);
                closeModal('editModal'); renderItinerary(); setTimeout(saveData, 50);
            }
        }

        // --- PERSONAL INFO ---
        const INFO_FIELDS = [
            { key: 'nameCh', label: '中文姓名' }, { key: 'nameEn', label: '英文姓名' },
            { key: 'passport', label: '護照號碼' }, { key: 'passportExpiry', label: '護照效期' }
        ];
        function renderPersonalInfo() {
            const c = document.getElementById('personalInfoContainer'); c.innerHTML = '';
            if(!appData.personalInfo) appData.personalInfo = {};
            INFO_FIELDS.forEach(f => {
                const val = appData.personalInfo[f.key] || '';
                c.innerHTML += `<div class="input-group"><div style="flex:1;"><label style="font-size:0.8rem;color:#666;">${f.label}</label><input type="text" id="pi-${f.key}" value="${val}" style="margin-bottom:0;" oninput="updatePI('${f.key}',this.value)"></div><button class="btn-copy" onclick="copyText('pi-${f.key}')"><i class="fa-regular fa-copy"></i></button></div>`;
            });
        }
        function updatePI(k, v) { appData.personalInfo[k] = v; saveData(); }
        function copyText(id) {
            const el = document.getElementById(id); el.select(); el.setSelectionRange(0,99999);
            try { navigator.clipboard.writeText(el.value); } catch(e) { document.execCommand('copy'); }
            const oldBg = el.style.backgroundColor; el.style.backgroundColor='#dcfce7'; setTimeout(()=>el.style.backgroundColor=oldBg,300);
        }

        // --- MEMOS ---
        function renderMemos() {
            const c = document.getElementById('memoContainer'); c.innerHTML = '';
            if(!appData.memos || appData.memos.length===0) { c.innerHTML='<div style="color:#aaa;text-align:center;">無筆記</div>'; return; }
            appData.memos.forEach(m => {
                let img = m.image ? `<img src="${m.image}" class="memo-img" onclick="openMemoSpotlight(${m.id})">` : '';
                c.innerHTML += `
                <div class="memo-card">
                    <div class="memo-text">${linkify(m.text)}</div>${img}
                    <div class="memo-actions">
                        <button class="btn btn-sm" style="background:#555;" onclick="editMemo(${m.id})"><i class="fa-solid fa-pen"></i></button>
                        <button class="btn btn-sm" style="background:#222;" onclick="openMemoSpotlight(${m.id})"><i class="fa-solid fa-expand"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="deleteMemo(${m.id})"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>`;
            });
        }
        function openMemoModal(id=null) {
            document.getElementById('memoId').value = id || '';
            document.getElementById('memoText').value = '';
            clearEditImage('memo');
            if(id) {
                const m = appData.memos.find(x=>x.id===id);
                document.getElementById('memoText').value = m.text;
                if(m.image) {
                    currentEditingImage = m.image;
                    document.getElementById('memoImagePreview').src = m.image;
                    document.getElementById('memoImagePreviewContainer').style.display = 'block';
                }
            }
            document.getElementById('memoModal').classList.remove('hidden');
        }
        function editMemo(id) { openMemoModal(id); }
        function saveMemo() {
            const txt = document.getElementById('memoText').value;
            const idVal = document.getElementById('memoId').value;
            const id = idVal ? parseInt(idVal) : Date.now();
            if(!txt && !currentEditingImage) return alert('空白');
            const newMemo = { id: id, text: txt, image: currentEditingImage };
            if(!appData.memos) appData.memos = [];
            if(idVal) {
                const idx = appData.memos.findIndex(m=>m.id===id);
                if(idx!==-1) appData.memos[idx] = newMemo;
            } else {
                appData.memos.unshift(newMemo);
            }
            closeModal('memoModal'); renderMemos(); setTimeout(saveData, 50);
        }
        function deleteMemo(id) { if(confirm('刪除?')) { appData.memos=appData.memos.filter(m=>m.id!==id); renderMemos(); setTimeout(saveData,50); } }

        // --- CHECKLIST ---
        function renderChecklist() {
            const c = document.getElementById('checklistContainer'); c.innerHTML = '';
            appData.checklist.forEach((item, idx) => {
                c.innerHTML += `<div class="checklist-item ${item.checked?'checked':''}" onclick="toggleCheck(${idx})">
                    <input type="checkbox" ${item.checked?'checked':''}><span>${item.text}</span>
                    <button style="margin-left:auto;background:none;border:none;color:#666;" onclick="deleteCheck(${idx},event)">x</button>
                </div>`;
            });
        }
        function toggleCheck(i) { appData.checklist[i].checked = !appData.checklist[i].checked; renderChecklist(); setTimeout(saveData,50); }
        function addCheckItem() { const inp=document.getElementById('newCheckItem'); if(inp.value){ appData.checklist.push({text:inp.value,checked:false}); inp.value=''; renderChecklist(); setTimeout(saveData,50); }}
        function deleteCheck(i,e) { e.stopPropagation(); if(confirm('刪除?')){ appData.checklist.splice(i,1); renderChecklist(); setTimeout(saveData,50); } }

        // --- UTILS ---
        function switchTab(id, el) {
            activeTabId = id;
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            if(el) el.classList.add('active');
            const fab = document.getElementById('fabAdd');
            if(id === 'sec-itinerary' || id === 'sec-memo') fab.classList.remove('hidden'); else fab.classList.add('hidden');
            if(id === 'sec-itinerary') renderItinerary();
            if(id === 'sec-memo') renderMemos();
        }
        function handleFabClick() {
            if(activeTabId==='sec-itinerary') openEditModal();
            if(activeTabId==='sec-memo') openMemoModal();
        }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function linkify(txt) { return txt.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color:var(--primary);text-decoration:underline;">連結</a>'); }
        
        // --- IMAGE HANDLING ---
        function handleImageUpload(input, type) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image(); img.src = e.target.result;
                img.onload = function() {
                    const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
                    const MAX=800; let w=img.width, h=img.height;
                    if(w>h){ if(w>MAX){ h*=MAX/w; w=MAX; } } else { if(h>MAX){ w*=MAX/h; h=MAX; } }
                    cvs.width=w; cvs.height=h; ctx.drawImage(img,0,0,w,h);
                    currentEditingImage = cvs.toDataURL('image/jpeg', 0.7);
                    if(type==='itinerary') { document.getElementById('editImagePreview').src=currentEditingImage; document.getElementById('editImagePreviewContainer').style.display='block'; }
                    else { document.getElementById('memoImagePreview').src=currentEditingImage; document.getElementById('memoImagePreviewContainer').style.display='block'; }
                }
            };
            reader.readAsDataURL(file);
        }
        window.addEventListener('paste', function(e) {
            const type = !document.getElementById('editModal').classList.contains('hidden') ? 'itinerary' : 
                         (!document.getElementById('memoModal').classList.contains('hidden') ? 'memo' : null);
            if(!type) return;
            const items = (e.clipboardData||e.originalEvent.clipboardData).items;
            for(let i=0; i<items.length; i++) {
                if(items[i].type.indexOf('image')!==-1) {
                    const blob = items[i].getAsFile();
                    const r = new FileReader();
                    r.onload = function(ev) {
                        const img=new Image(); img.src=ev.target.result;
                        img.onload=function(){
                            const cvs=document.createElement('canvas'); const ctx=cvs.getContext('2d');
                            const MAX=800; let w=img.width, h=img.height;
                            if(w>h){ if(w>MAX){ h*=MAX/w; w=MAX; } } else { if(h>MAX){ w*=MAX/h; h=MAX; } }
                            cvs.width=w; cvs.height=h; ctx.drawImage(img,0,0,w,h);
                            currentEditingImage=cvs.toDataURL('image/jpeg',0.7);
                            if(type==='itinerary'){document.getElementById('editImagePreview').src=currentEditingImage; document.getElementById('editImagePreviewContainer').style.display='block';}
                            else{document.getElementById('memoImagePreview').src=currentEditingImage; document.getElementById('memoImagePreviewContainer').style.display='block';}
                        }
                    };
                    r.readAsDataURL(blob);
                }
            }
        });
        function clearEditImage(type) {
            currentEditingImage = null;
            if(type==='itinerary') { document.getElementById('editImageInput').value=''; document.getElementById('editImagePreviewContainer').style.display='none'; }
            else { document.getElementById('memoImageInput').value=''; document.getElementById('memoImagePreviewContainer').style.display='none'; }
        }

        // --- SPOTLIGHT ---
        function openMemoSpotlight(id) {
            const m = appData.memos.find(x=>x.id===id); if(!m) return;
            document.getElementById('memoSpotlightText').innerText = m.text;
            const img = document.getElementById('memoSpotlightImg');
            if(m.image) { img.src=m.image; img.classList.remove('hidden'); } else { img.classList.add('hidden'); }
            document.getElementById('memoSpotlight').classList.remove('hidden');
        }
        function closeMemoSpotlight() { document.getElementById('memoSpotlight').classList.add('hidden'); }
        function openLightbox(src) { document.getElementById('lightboxImg').src=src; document.getElementById('lightbox').classList.remove('hidden'); }
        function closeLightbox() { document.getElementById('lightbox').classList.add('hidden'); }

        // --- WEATHER ---
        async function fetchWeather() {
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=35.6895&longitude=139.6917&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia%2FTokyo&forecast_days=3`);
                const data = await res.json();
                let html = '<div style="margin-bottom:10px;font-weight:bold;border-bottom:1px solid rgba(255,255,255,0.3);padding-bottom:5px;">東京 3 日預報</div>';
                for(let i=0; i<3; i++) {
                    const c = data.daily.weathercode[i];
                    let icon='fa-sun', desc='晴/多雲';
                    if(c>3){icon='fa-cloud';desc='陰天';} if(c>50){icon='fa-umbrella';desc='有雨';}
                    const d = new Date(); d.setDate(d.getDate()+i);
                    html += `<div class="weather-day-row"><div style="flex:1;">${d.getMonth()+1}/${d.getDate()}</div><div style="flex:1;text-align:center;"><i class="fa-solid ${icon}"></i> ${desc}</div><div style="flex:1;text-align:right;"><span class="temp-high">${data.daily.temperature_2m_max[i]}°</span> <span class="temp-low">${data.daily.temperature_2m_min[i]}°</span></div></div>`;
                }
                document.getElementById('weatherDisplay').innerHTML = html;
            } catch(e) { document.getElementById('weatherDisplay').innerHTML = '氣象載入失敗'; }
        }
    </script>
</body>
</html>
